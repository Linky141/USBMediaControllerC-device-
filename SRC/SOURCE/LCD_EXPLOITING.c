/*#######################################################################*/
/*#######################################################################*/
/* IMPLEMENTACJE */

#include "../HEADERS/LCD_EXPLOITING.h"

/*#######################################################################*/
/*#######################################################################*/
/* IMPLEMENTACJA METOD */

//------------------------------------------------------------------------
//Metoda odpowiadaj¹ca za ustawianie jasnoœci ekranu.
void LCDEXPLOITING_SetLctBrightness(int val) {

	//gdy wartoœæ ustawiona bêdzie poza zakresem wtedy metoda siê nie wykona
	if (val < 0 || val > 100)
		return;

	//W przyadku obecnego PWM wartoœci¹ 0 jest stan wysoki a pwm dzia³a poprzez zbijanie do stanu niskiego.
	//Aby ustawienie by³o intuicyjne nale¿y wykonaæ inwersje wartoœci w przedziale 0 - 100
	int tmp = 100 - val;

	//nastêpnie zostaje ustawione wype³nienie dla PWM z podœwietleniem ekranu
	PWM_SetDutyCycle(1, tmp);
}

//------------------------------------------------------------------------
//metoda odpowiedzialna za odczyt etykiet po UART oraz zapisywaniu ich w zmiennych które bêd¹ wyœwietlane w
//odpowiednich miejscach na odpowiednich stronach.
//Metoda przyjmuje strukturê zawieaj¹c¹ wszystkie eytkiety oraz ustawienia w celu zarz¹dzania aktywnoœci¹ diody powiadomieñ
void screen_show_initialize(struct LCDEXPLOITING_AllPages *lcdPageLabbles,
		struct SettingsMenu_values *settinsgMenu_values) {

	//W pierwszej kolejnoœci nastepuje wyczyszczenie ekranu, wyœwietlenie informacji o stanie oczekiwania na przes³anie
	//etykiet oraz wy³¹cenie diody powiadomieñ w czasie 500ms i ustawienie jasnoœci ekranu na 0.
	LCD_Clear();
	LCD_XYPrintf(3, 0, "Waiting for");
	LCD_XYPrintf(5, 1, "labels");
	LedControl_OFF(500);
	LCDEXPLOITING_SetLctBrightness(0);

	//Wys³anie przez UART informacji o gotowoœci odczytu etykiet.
	//S³u¿y do automatyzacji wysy³ania etykiet z kompuera po restarcie urz¹dzenia.
	UART_Printf("RTW!\n");

	//------------------POBIERANIE ETYKIETY DO POLA 1 NA STRONIE 1
	//odczyt wartoœci z UART do odpowiedniego pola na odpowiedniej stronie.
	//Nastepnie przywrócenia podœwietlenia ekranu do ustawionej wartoœci
	//Wyœwietlenie fragmentu animacji wczytywania zmiennych.
	UARTCOMMUNICATION_recive(lcdPageLabbles->page1.field1);
	LCDEXPLOITING_SetLctBrightness(settinsgMenu_values->pwmBrightness);
	DrawLoading(11, 1, lcdPageLabbles->page1.field1,
			settinsgMenu_values->debugMode);

	//------------------POBIERANIE ETYKIETY DO POLA 2 NA STRONIE 1
	//odczyt wartoœci z UART do odpowiedniego pola na odpowiedniej stronie.
	//Wyœwietlenie fragmentu animacji wczytywania zmiennych.
	UARTCOMMUNICATION_recive(lcdPageLabbles->page1.field2);
	DrawLoading(12, 2, lcdPageLabbles->page1.field2,
			settinsgMenu_values->debugMode);

	//------------------POBIERANIE ETYKIETY DO POLA 3 NA STRONIE 1
	//odczyt wartoœci z UART do odpowiedniego pola na odpowiedniej stronie.
	//Wyœwietlenie fragmentu animacji wczytywania zmiennych.
	UARTCOMMUNICATION_recive(lcdPageLabbles->page1.field3);
	DrawLoading(13, 3, lcdPageLabbles->page1.field3,
			settinsgMenu_values->debugMode);

	//------------------POBIERANIE ETYKIETY DO POLA 4 NA STRONIE 1
	//odczyt wartoœci z UART do odpowiedniego pola na odpowiedniej stronie.
	//Wyœwietlenie fragmentu animacji wczytywania zmiennych.
	UARTCOMMUNICATION_recive(lcdPageLabbles->page1.field4);
	DrawLoading(14, 4, lcdPageLabbles->page1.field4,
			settinsgMenu_values->debugMode);

	//------------------POBIERANIE ETYKIETY DO POLA 1 NA STRONIE 2
	//odczyt wartoœci z UART do odpowiedniego pola na odpowiedniej stronie.
	//Wyœwietlenie fragmentu animacji wczytywania zmiennych.
	UARTCOMMUNICATION_recive(lcdPageLabbles->page2.field1);
	DrawLoading(21, 5, lcdPageLabbles->page2.field1,
			settinsgMenu_values->debugMode);

	//------------------POBIERANIE ETYKIETY DO POLA 2 NA STRONIE 2
	//odczyt wartoœci z UART do odpowiedniego pola na odpowiedniej stronie.
	//Wyœwietlenie fragmentu animacji wczytywania zmiennych.
	UARTCOMMUNICATION_recive(lcdPageLabbles->page2.field2);
	DrawLoading(22, 6, lcdPageLabbles->page2.field2,
			settinsgMenu_values->debugMode);

	//------------------POBIERANIE ETYKIETY DO POLA 3 NA STRONIE 2
	//odczyt wartoœci z UART do odpowiedniego pola na odpowiedniej stronie.
	//Wyœwietlenie fragmentu animacji wczytywania zmiennych.
	UARTCOMMUNICATION_recive(lcdPageLabbles->page2.field3);
	DrawLoading(23, 7, lcdPageLabbles->page2.field3,
			settinsgMenu_values->debugMode);

	//------------------POBIERANIE ETYKIETY DO POLA 4 NA STRONIE 2
	//odczyt wartoœci z UART do odpowiedniego pola na odpowiedniej stronie.
	//Wyœwietlenie fragmentu animacji wczytywania zmiennych.
	UARTCOMMUNICATION_recive(lcdPageLabbles->page2.field4);
	DrawLoading(24, 8, lcdPageLabbles->page2.field4,
			settinsgMenu_values->debugMode);

	//------------------POBIERANIE ETYKIETY DO POLA 1 NA STRONIE 3
	//odczyt wartoœci z UART do odpowiedniego pola na odpowiedniej stronie.
	//Wyœwietlenie fragmentu animacji wczytywania zmiennych.
	UARTCOMMUNICATION_recive(lcdPageLabbles->page3.field1);
	DrawLoading(31, 9, lcdPageLabbles->page3.field1,
			settinsgMenu_values->debugMode);

	//------------------POBIERANIE ETYKIETY DO POLA 2 NA STRONIE 3
	//odczyt wartoœci z UART do odpowiedniego pola na odpowiedniej stronie.
	//Wyœwietlenie fragmentu animacji wczytywania zmiennych.
	UARTCOMMUNICATION_recive(lcdPageLabbles->page3.field2);
	DrawLoading(32, 10, lcdPageLabbles->page3.field2,
			settinsgMenu_values->debugMode);

	//------------------POBIERANIE ETYKIETY DO POLA 3 NA STRONIE 3
	//odczyt wartoœci z UART do odpowiedniego pola na odpowiedniej stronie.
	//Wyœwietlenie fragmentu animacji wczytywania zmiennych.
	UARTCOMMUNICATION_recive(lcdPageLabbles->page3.field3);
	DrawLoading(33, 11, lcdPageLabbles->page3.field3,
			settinsgMenu_values->debugMode);

	//------------------POBIERANIE ETYKIETY DO POLA 4 NA STRONIE 3
	//odczyt wartoœci z UART do odpowiedniego pola na odpowiedniej stronie.
	//Wyœwietlenie fragmentu animacji wczytywania zmiennych.
	UARTCOMMUNICATION_recive(lcdPageLabbles->page3.field4);
	DrawLoading(34, 12, lcdPageLabbles->page3.field4,
			settinsgMenu_values->debugMode);

	//------------------POBIERANIE ETYKIETY DO POLA 1 NA STRONIE 4
	//odczyt wartoœci z UART do odpowiedniego pola na odpowiedniej stronie.
	//Wyœwietlenie fragmentu animacji wczytywania zmiennych.
	UARTCOMMUNICATION_recive(lcdPageLabbles->page4.field1);
	DrawLoading(41, 13, lcdPageLabbles->page4.field1,
			settinsgMenu_values->debugMode);

	//------------------POBIERANIE ETYKIETY DO POLA 2 NA STRONIE 4
	//odczyt wartoœci z UART do odpowiedniego pola na odpowiedniej stronie.
	//Wyœwietlenie fragmentu animacji wczytywania zmiennych.
	UARTCOMMUNICATION_recive(lcdPageLabbles->page4.field2);
	DrawLoading(42, 14, lcdPageLabbles->page4.field2,
			settinsgMenu_values->debugMode);

	//------------------POBIERANIE ETYKIETY DO POLA 3 NA STRONIE 4
	//odczyt wartoœci z UART do odpowiedniego pola na odpowiedniej stronie.
	//Wyœwietlenie fragmentu animacji wczytywania zmiennych.
	UARTCOMMUNICATION_recive(lcdPageLabbles->page4.field3);
	DrawLoading(43, 15, lcdPageLabbles->page4.field3,
			settinsgMenu_values->debugMode);

	//------------------POBIERANIE ETYKIETY DO POLA 4 NA STRONIE 4
	//odczyt wartoœci z UART do odpowiedniego pola na odpowiedniej stronie.
	//Wyœwietlenie fragmentu animacji wczytywania zmiennych.
	UARTCOMMUNICATION_recive(lcdPageLabbles->page4.field4);
	DrawLoading(44, 16, lcdPageLabbles->page4.field4,
			settinsgMenu_values->debugMode);

	//Po wczytaniu wszystkich etykiet nastêpuje 500ms przerwy po czym informacja o zakonczeniu inicjalizacji
	_delay_ms(500);
	LCD_Clear();
	LCD_XYPrintf(0, 0, "initialization");
	LCD_XYPrintf(0, 1, "completed");

	//w przypadku aktywnej diody powiadomieñ dioda kilka razy siê w³¹czy i wy³¹czy w czasie 125ms aby na koñcu siê wy³¹czyæ w czasie 200ms.
	//jest to powiadomienie o zakonczeniu pobierania etykiet z UART oraz koncu inicjalizacji
	if (settinsgMenu_values->ledStatus) {
		LedControl_OFF(125);
		LedControl_ON(125);
		LedControl_OFF(125);
		LedControl_ON(125);
		LedControl_OFF(125);
		LedControl_ON(125);
		LedControl_OFF(125);
		LedControl_ON(125);
		LedControl_OFF(200);
	}

	//W przypadku wy³¹czonej diody powiadomieñ program odczeka czas który by zajê³a informacja diody powiadomieñ o zakonczeniu inicjalizacji
	else
		DELAY_ms(1200);
	LCD_Clear();
}

//------------------------------------------------------------------------
//Metoda odpowiedzialna za wyœwietlanie etykiet na aktualnej stronie
void LCDEXPLOITING_showPage(int page,
		struct LCDEXPLOITING_AllPages *lcdPageLabbles) {

	//najpierw nastêpuje czyszczenie ekranu
	LCD_Clear();

	//kolejnie utworzona jest zmienna iloœci spacji do prawid³owego rozmieszczenia etykiet po rogach ekranu
	int space;

	//Gdy aktualnie bêdzie 1 strona
	if (page == 1) {

		//wyœwietlenie etykiety na polu numer 1
		LCD_XYPrintf(0, 0, "%s", lcdPageLabbles->page1.field1);

		//obliczanie o ile trzeba przesun¹æ etykietê w prawo aby etykieta na 2 polu by³a maksymalnie z prawej strony
		space = LCDEXPLOITING_howLong(lcdPageLabbles->page1.field2);

		//wyœwietlenie etykiety na polu numer 2
		LCD_XYPrintf((9 + space), 0, "%s", lcdPageLabbles->page1.field2);

		//wyœwietlenie etykiety na polu numer 3
		LCD_XYPrintf(0, 1, "%s", lcdPageLabbles->page1.field3);

		//obliczanie o ile trzeba przesun¹æ etykietê w prawo aby etykieta na 4 polu by³a maksymalnie z prawej strony
		space = LCDEXPLOITING_howLong(lcdPageLabbles->page1.field4);

		//wyœwietlenie etykiety na polu numer 4
		LCD_XYPrintf((9 + space), 1, "%s", lcdPageLabbles->page1.field4);
	}

	//Gdy aktualnie bêdzie 2 strona
	else if (page == 2) {

		//wyœwietlenie etykiety na polu numer 1
		LCD_XYPrintf(0, 0, "%s", lcdPageLabbles->page2.field1);

		//obliczanie o ile trzeba przesun¹æ etykietê w prawo aby etykieta na 2 polu by³a maksymalnie z prawej strony
		space = LCDEXPLOITING_howLong(lcdPageLabbles->page2.field2);

		//wyœwietlenie etykiety na polu numer 2
		LCD_XYPrintf((9 + space), 0, "%s", lcdPageLabbles->page2.field2);

		//wyœwietlenie etykiety na polu numer 3
		LCD_XYPrintf(0, 1, "%s", lcdPageLabbles->page2.field3);

		//obliczanie o ile trzeba przesun¹æ etykietê w prawo aby etykieta na 4 polu by³a maksymalnie z prawej strony
		space = LCDEXPLOITING_howLong(lcdPageLabbles->page2.field4);

		//wyœwietlenie etykiety na polu numer 4
		LCD_XYPrintf((9 + space), 1, "%s", lcdPageLabbles->page2.field4);
	}

	//Gdy aktualnie bêdzie 3 strona
	else if (page == 3) {

		//wyœwietlenie etykiety na polu numer 1
		LCD_XYPrintf(0, 0, "%s", lcdPageLabbles->page3.field1);

		//obliczanie o ile trzeba przesun¹æ etykietê w prawo aby etykieta na 2 polu by³a maksymalnie z prawej strony
		space = LCDEXPLOITING_howLong(lcdPageLabbles->page3.field2);

		//wyœwietlenie etykiety na polu numer 2
		LCD_XYPrintf((9 + space), 0, "%s", lcdPageLabbles->page3.field2);

		//wyœwietlenie etykiety na polu numer 3
		LCD_XYPrintf(0, 1, "%s", lcdPageLabbles->page3.field3);

		//obliczanie o ile trzeba przesun¹æ etykietê w prawo aby etykieta na 4 polu by³a maksymalnie z prawej strony
		space = LCDEXPLOITING_howLong(lcdPageLabbles->page3.field4);

		//wyœwietlenie etykiety na polu numer 4
		LCD_XYPrintf((9 + space), 1, "%s", lcdPageLabbles->page3.field4);
	}

	//Gdy aktualnie bêdzie 4 strona
	else if (page == 4) {

		//wyœwietlenie etykiety na polu numer 1
		LCD_XYPrintf(0, 0, "%s", lcdPageLabbles->page4.field1);

		//obliczanie o ile trzeba przesun¹æ etykietê w prawo aby etykieta na 2 polu by³a maksymalnie z prawej strony
		space = LCDEXPLOITING_howLong(lcdPageLabbles->page4.field2);

		//wyœwietlenie etykiety na polu numer 2
		LCD_XYPrintf((9 + space), 0, "%s", lcdPageLabbles->page4.field2);

		//wyœwietlenie etykiety na polu numer 3
		LCD_XYPrintf(0, 1, "%s", lcdPageLabbles->page4.field3);

		//obliczanie o ile trzeba przesun¹æ etykietê w prawo aby etykieta na 4 polu by³a maksymalnie z prawej strony
		space = LCDEXPLOITING_howLong(lcdPageLabbles->page4.field4);

		//wyœwietlenie etykiety na polu numer 4
		LCD_XYPrintf((9 + space), 1, "%s", lcdPageLabbles->page4.field4);
	}

}

//------------------------------------------------------------------------
//metoda do obliczania o ile nale¿y przesun¹æ etykietê aby by³a maksymalnie z prawej strony
int LCDEXPLOITING_howLong(char *chars) {

	//najpierw inicjalizuje zmienne d³ugoœci etykiety oraz iloœci specjalnych znaków (specjalne znaki zawieraj¹ w ci¹gu % + znak
	//lecz wyœwietlane s¹ jako jeden znak
	int size = 0;
	int specialSymbols = 0;

	//kolejnie w pêtli iterowane s¹ znaki etykiety tak d³ugo a¿ pêtla dojdzie do znaku koñca
	for (int clk = 0; chars[clk] != '\0'; clk++) {

		//za ka¿dym obiegiem pêtli zwiêkszany jest rozmiar
		size++;

		//je¿eli obecny znak to '%' wtedy licznik specjalnych znaków zostaje ziwekszony
		if (chars[clk] == '%')
			specialSymbols++;
	}

	//zostaje zwrócona iloœæ znaków o które trzeba przesun¹æ etykietê w prawo by by³a maksymalnie po prawej stronie.
	//zostaje to wyliczone poprzez odjêcie od rozmiaru pola (7 poniewa¿ zaczyna od 0 wiêc jest 8) d³ugoœci ci¹gu.
	//do tego dodana zostaje iloœæ specjalnych znaków gdy¿ na ka¿dy jeden znak specjalny wyœwietlany przypadaj¹ 2 znaki w kodzie.
	return ((7 - size) + specialSymbols);
}

//------------------------------------------------------------------------
//metoda odpowiada za wyœwietlanie paska ³adowania podczas inicjalizacji. Przesy³ana jest do niej d³ugoœæ paska
//Wyœwietlanie paska odbywa siê na dole ekranu
void LCDEXPLOITING_DrawLoading(int length) {

	//Pêtla wykonuje siê tak¹ iloœæ razy ile znaków ma zajmowaæ pasek ³adowania
	for (int clk = 0; clk < length; clk++) {

		//w odpowidnim polu wypisuje znak ³adowania (ca³y segment zamalowany)
		LCD_XYPrintf(clk, 1, "%?");
	}
}

//------------------------------------------------------------------------
//metoda odpowiada za wyœwietlanie informacji ¿e nale¿y poczekaæ lub w trybie debugowym informacji
//o aktualnej stronie o polu oraz odebranej etykiecie
//Wyœwietlanie informacji odbywa siê na górnej czêœci ekranu
void DrawLoading(int pagefield, int loadingPorgress, const char *lbl,
bool debugMode) {

	//metoda najpierw czyœci ekran
	LCD_Clear();

	//nastêpnie w przypadku aktywnego trybu debugowego na górnej czêœci ekranu pierw wyœwietla numer strony i numer pola
	//a nastêpnie odebran¹ etykietê
	if (debugMode == 1)
		LCD_XYPrintf(0, 0, "%d:%s", pagefield, lbl);

	//w przypadku wy³¹czonego trybu debugowego na górnym ekranie wyœwietlona zostanie informacja proszê czekaæ
	else
		LCD_XYPrintf(0, 0, "Please wait");

	//nastêpnie zostanie wyœwietlony odpowiednio d³ugi pasek ³adowania
	LCDEXPLOITING_DrawLoading(loadingPorgress);
}
